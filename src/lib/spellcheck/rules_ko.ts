export type Rule = {
  pattern: RegExp;
  replace: string;
  reason: string;
  confidence?: number;
};

const r = (pattern: string | RegExp, replace: string, reason: string, confidence = 0.8): Rule => ({
  pattern:
    typeof pattern === "string"
      ? new RegExp(pattern, "g")
      : new RegExp(pattern.source, pattern.flags.includes("g") ? pattern.flags : pattern.flags + "g"),
  replace,
  reason,
  confidence,
});

const spacingReason = (reason: string, confidence = 0.8) => {
  const base = reason.includes("띄어쓰기") ? reason : `띄어쓰기: ${reason}`;
  if (confidence < 0.6 && !base.includes("제안")) return `${base} (제안)`;
  return base;
};

const rSpacing = (pattern: string | RegExp, replace: string, reason: string, confidence = 0.8): Rule =>
  r(pattern, replace, spacingReason(reason, confidence), confidence);

const makePastTypos = (): Rule[] => {
  const pairs: Array<[string, string]> = [
    ["있엇", "있었"],
    ["없엇", "없었"],
    ["같앗", "같았"],
    ["싫엇", "싫었"],
    ["좋앗", "좋았"],
    ["많앗", "많았"],
    ["말햇", "말했"],
    ["생각햇", "생각했"],
    ["잊엇", "잊었"],
    ["겪엇", "겪었"],
    ["먹엇", "먹었"],
    ["마셧", "마셨"],
    ["보앗", "보았"],
    ["그랫", "그랬"],
    ["버렷", "버렸"],
    ["들어왓", "들어왔"],
    ["나왓", "나왔"],
    ["봣", "봤"],
  ];

  const endings = ["다", "어", "는데", "지만", "던", "을", "지", "고"];
  const rules: Rule[] = [];
  for (const [bad, good] of pairs) {
    for (const e of endings) {
      rules.push(r(`${bad}${e}`, `${good}${e}`, `과거형 표기: ${good}${e}`, 0.95));
    }
  }
  return rules;
};

const makeSpacingParticles = (): Rule[] => {
  const rules: Rule[] = [];

  const suTail =
    "(?:없|있|도|가|는|만|까지|부터|밖에|조차|뿐|라도|라면|라서|라는|라며|라니|라고|라곤|라니까|라기에|라길래|라지|라네요|랍니다|랍시다|라오|라네|라는지|라면서|라지만|라치면|라치고|라더라|라더니|라면요|랴|로|다|에|니|야|였다|였|일|겠|[\\s.,!?]|$)";
  const suStems = [
    "할",
    "될",
    "볼",
    "갈",
    "울",
    "있을",
    "없을",
    "그럴",
    "이럴",
    "저럴",
    "보낼",
    "만날",
    "견딜",
    "도울",
    "막을",
    "바랄",
    "읽을",
    "쓸",
    "먹을",
    "마실",
    "살릴",
    "고칠",
    "붙일",
    "준비할",
    "정리할",
    "적을",
    "늘릴",
    "줄일",
    "참을",
    "버틸",
    "돌아올",
    "돌아갈",
    "나올",
    "나갈",
    "들어올",
    "들어갈",
    "지킬",
    "돕",
    "막아낼",
    "견뎌낼",
    "떠날",
    "찾을",
  ];
  for (const v of suStems) {
    rules.push(rSpacing(new RegExp(`${v}수(?=${suTail})`, "g"), `${v} 수`, "‘수’ 띄어쓰기", 0.9));
  }

  const geoTail =
    "(?:야|라|다|죠|지|야죠|라도|라면|라서|라는|라니|라고|라곤|라니까|라기에|라길래|라지|라네요|랍니다|랍시다|라오|라네|라는지|라면서|라지만|라치면|라치고|라더라|라더니|라면요|랴|면|였|였다|였던|였는데|였으나|[\\s.,!?]|$)";
  const geoStems = [
    "인",
    "하는",
    "되는",
    "있는",
    "없는",
    "같은",
    "할",
    "볼",
    "갈",
    "될",
    "먹는",
    "보는",
    "사는",
    "느끼는",
    "믿는",
    "줄이는",
    "늘리는",
    "하려는",
    "되려는",
    "하려고한",
    "되려고한",
    "살려는",
    "지키려는",
    "만들려는",
  ];
  for (const p of geoStems) {
    rules.push(rSpacing(new RegExp(`${p}거(?=${geoTail})`, "g"), `${p} 거`, "‘거’ 띄어쓰기", 0.88));
  }

  const deutTail =
    "(?:하|했|할|한|해|싶|말|보|들|싶었|싶어|싶다|싶지|싶네|싶군|싶을|싶으면|싶어서|싶었으면|싶을까|싶다면|싶다는|싶다는걸|싶을수록|싶었지만|[\\s.,!?]|$)";
  const deutStems = [
    "할",
    "될",
    "볼",
    "갈",
    "끊길",
    "울",
    "죽을",
    "맞을",
    "바랄",
    "있을",
    "없을",
    "그럴",
    "이럴",
    "저럴",
    "흘러갈",
    "흔들릴",
    "알",
    "모를",
    "싶을",
    "했을",
    "될것같",
    "할것같",
    "보일",
    "느껴질",
    "남을",
    "바쁠",
    "될거같",
  ];
  for (const p of deutStems) {
    rules.push(rSpacing(new RegExp(`${p}듯(?!이)(?=${deutTail})`, "g"), `${p} 듯`, "‘듯’ 띄어쓰기", 0.86));
  }

  const ttaeTail =
    "(?:는|다|라도|라면|라서|부터|마다|엔|에|만|까지|였다|였|였던|였을|였는데|였다면|라곤|[\\s.,!?]|$)";
  const ttaeStems = [
    "할",
    "될",
    "볼",
    "갈",
    "올",
    "쉴",
    "만날",
    "돌아올",
    "들어올",
    "나올",
    "먹을",
    "만들",
    "쓸",
    "잠들",
    "울",
    "웃",
    "갈까",
    "볼까",
    "할까",
    "있을",
    "없을",
    "끝날",
    "시작할",
    "돌아갈",
    "도착할",
    "떴을",
    "감았을",
    "들었을",
    "올라올",
    "불어올",
  ];
  for (const p of ttaeStems) {
    rules.push(rSpacing(new RegExp(`${p}때(?!문)(?=${ttaeTail})`, "g"), `${p} 때`, "‘때’ 띄어쓰기", 0.82));
  }

  rules.push(rSpacing(/뿐만아니라/g, "뿐만 아니라", "‘뿐만 아니라’ 띄어쓰기", 0.92));
  rules.push(rSpacing(/밖에없/g, "밖에 없", "‘밖에 없다’ 띄어쓰기", 0.87));
  return rules;
};

const makeSpacingNumeric = (): Rule[] => {
  const rules: Rule[] = [];
  const counterPairs: Array<[string, string, number]> = [
    ["몇번", "몇 번", 0.93],
    ["몇번씩", "몇 번씩", 0.92],
    ["몇번이나", "몇 번이나", 0.92],
    ["한두번", "한두 번", 0.84],
    ["두번", "두 번", 0.83],
    ["세번", "세 번", 0.82],
    ["네번", "네 번", 0.8],
    ["두세번", "두세 번", 0.76],
    ["한번씩", "한 번씩", 0.61],
    ["한번만", "한 번만", 0.6],
    ["한번은", "한 번은", 0.6],
    ["한번이라도", "한 번이라도", 0.6],
    ["한번쯤", "한 번쯤", 0.6],
    ["한번", "한 번", 0.58],
    ["몇가지", "몇 가지", 0.82],
  ];

  const gajiWords: Array<[string, string]> = [
    ["한가지", "한 가지"],
    ["두가지", "두 가지"],
    ["세가지", "세 가지"],
    ["네가지", "네 가지"],
    ["다섯가지", "다섯 가지"],
    ["여섯가지", "여섯 가지"],
    ["일곱가지", "일곱 가지"],
    ["여덟가지", "여덟 가지"],
    ["아홉가지", "아홉 가지"],
    ["열가지", "열 가지"],
  ];
  for (const [bad, good] of gajiWords) {
    counterPairs.push([bad, good, 0.68]);
  }

  const numericGaji: Array<[string, string]> = [
    ["1가지", "한 가지"],
    ["2가지", "두 가지"],
    ["3가지", "세 가지"],
    ["4가지", "네 가지"],
    ["5가지", "다섯 가지"],
    ["6가지", "여섯 가지"],
    ["7가지", "일곱 가지"],
    ["8가지", "여덟 가지"],
    ["9가지", "아홉 가지"],
    ["10가지", "열 가지"],
  ];
  for (const [bad, good] of numericGaji) {
    counterPairs.push([bad, good, 0.62]);
  }

  for (const [bad, good, confidence] of counterPairs) {
    rules.push(rSpacing(bad, good, "수사/의존명사 띄어쓰기", confidence));
  }
  return rules;
};

const makeSpacingPhrases = (): Rule[] => {
  const rules: Rule[] = [];
  const add = (pattern: string | RegExp, replace: string, confidence: number, reason: string) =>
    rules.push(rSpacing(pattern, replace, reason, confidence));

  const phrasePairs: Array<[string | RegExp, string, number, string]> = [
    ["눈을떴을때", "눈을 떴을 때", 0.94, "관용 표현 띄어쓰기"],
    ["눈을감았을때", "눈을 감았을 때", 0.86, "관용 표현 띄어쓰기"],
    ["눈을뜨고나서", "눈을 뜨고 나서", 0.82, "관용 표현 띄어쓰기"],
    ["집에돌아와서", "집에 돌아와서", 0.9, "관용 표현 띄어쓰기"],
    ["집에돌아와도", "집에 돌아와도", 0.82, "관용 표현 띄어쓰기"],
    ["집에돌아오면", "집에 돌아오면", 0.82, "관용 표현 띄어쓰기"],
    ["집에돌아왔는데", "집에 돌아왔는데", 0.82, "관용 표현 띄어쓰기"],
    ["집에돌아가는길", "집에 돌아가는 길", 0.82, "관용 표현 띄어쓰기"],
    ["집에돌아오는길", "집에 돌아오는 길", 0.82, "관용 표현 띄어쓰기"],
    ["밥을먹으러", "밥을 먹으러", 0.92, "목적격 뒤 띄어쓰기"],
    ["밥을먹고", "밥을 먹고", 0.86, "목적격 뒤 띄어쓰기"],
    ["밥을먹어도", "밥을 먹어도", 0.82, "목적격 뒤 띄어쓰기"],
    ["밥을먹을때", "밥을 먹을 때", 0.84, "목적격 뒤 띄어쓰기"],
    ["연락할까하다가", "연락할까 하다가", 0.55, "동사 연결 띄어쓰기"],
    ["연락하려고하다가", "연락하려고 하다가", 0.55, "동사 연결 띄어쓰기"],
    ["연락하려고했는데", "연락하려고 했는데", 0.55, "동사 연결 띄어쓰기"],
    ["되게많이", "되게 많이", 0.72, "부사 연결 띄어쓰기"],
    ["되게빨리", "되게 빨리", 0.72, "부사 연결 띄어쓰기"],
    ["되게조용히", "되게 조용히", 0.68, "부사 연결 띄어쓰기"],
    ["되게오래", "되게 오래", 0.7, "부사 연결 띄어쓰기"],
    ["되게기대", "되게 기대", 0.64, "부사 연결 띄어쓰기"],
    ["밖에나갔는데", "밖에 나갔는데", 0.75, "‘밖에’ 뒤 띄어쓰기"],
    ["밖에나가서", "밖에 나가서", 0.76, "‘밖에’ 뒤 띄어쓰기"],
    ["밖에나갔다가", "밖에 나갔다가", 0.74, "‘밖에’ 뒤 띄어쓰기"],
    ["밖에나와있", "밖에 나와 있", 0.72, "‘밖에’ 뒤 띄어쓰기"],
    ["아무것도안", "아무 것도 안", 0.45, "부정 표현 띄어쓰기"],
    ["아무것도", "아무 것도", 0.45, "부정 표현 띄어쓰기"],
    ["하루종일", "하루 종일", 0.48, "시간 표현 띄어쓰기"],
    ["될듯말듯", "될 듯 말 듯", 0.65, "관형사 결합 띄어쓰기"],
    ["될듯해서", "될 듯해서", 0.7, "관형사 결합 띄어쓰기"],
    ["할듯말듯", "할 듯 말 듯", 0.65, "관형사 결합 띄어쓰기"],
    ["갈듯말듯", "갈 듯 말 듯", 0.65, "관형사 결합 띄어쓰기"],
    ["끊길듯", "끊길 듯", 0.82, "관형사 결합 띄어쓰기"],
    ["될듯", "될 듯", 0.86, "관형사 결합 띄어쓰기"],
    ["할듯", "할 듯", 0.86, "관형사 결합 띄어쓰기"],
    ["갈듯", "갈 듯", 0.83, "관형사 결합 띄어쓰기"],
    ["할때마다", "할 때마다", 0.8, "시간 표현 띄어쓰기"],
    ["볼때마다", "볼 때마다", 0.8, "시간 표현 띄어쓰기"],
    ["갈때마다", "갈 때마다", 0.8, "시간 표현 띄어쓰기"],
    ["올때마다", "올 때마다", 0.78, "시간 표현 띄어쓰기"],
    ["끝났을때", "끝났을 때", 0.76, "시간 표현 띄어쓰기"],
    ["시작했을때", "시작했을 때", 0.76, "시간 표현 띄어쓰기"],
    ["눈을감고있", "눈을 감고 있", 0.68, "진행형 띄어쓰기"],
    ["문을열고있", "문을 열고 있", 0.68, "진행형 띄어쓰기"],
    ["집에돌아오고", "집에 돌아오고", 0.82, "관용 표현 띄어쓰기"],
    ["밖에없다고", "밖에 없다고", 0.82, "‘밖에 없다’ 띄어쓰기"],
    ["밖에없을", "밖에 없을", 0.82, "‘밖에 없다’ 띄어쓰기"],
    ["뿐만아닌", "뿐만 아닌", 0.78, "‘뿐만’ 띄어쓰기"],
    ["힘들때", "힘들 때", 0.82, "시간 표현 띄어쓰기"],
    ["바쁠때", "바쁠 때", 0.8, "시간 표현 띄어쓰기"],
    ["아플때", "아플 때", 0.82, "시간 표현 띄어쓰기"],
    ["잠들기전에", "잠들기 전에", 0.78, "시간 표현 띄어쓰기"],
    ["오기전에", "오기 전에", 0.78, "시간 표현 띄어쓰기"],
    ["가기전에", "가기 전에", 0.78, "시간 표현 띄어쓰기"],
    ["끝나고나서", "끝나고 나서", 0.78, "연결 어미 띄어쓰기"],
    ["돌아오고나서", "돌아오고 나서", 0.78, "연결 어미 띄어쓰기"],
    [/인듯(?=하|했|할|한|해|했|함|하다|하다가|[\\s.,!?]|$)/g, "인 듯", 0.72, "조사 결합 띄어쓰기"],
    [/같은데(?=서|라도|는|를|에|도|든|라서|라면|[\\s.,!?]|$)/g, "같은 데", 0.4, "조사 결합 띄어쓰기"],
    [/하는대로/g, "하는 대로", 0.55, "‘대로’ 띄어쓰기"],
    [/보는대로/g, "보는 대로", 0.55, "‘대로’ 띄어쓰기"],
    [/가는대로/g, "가는 대로", 0.55, "‘대로’ 띄어쓰기"],
    [/오는대로/g, "오는 대로", 0.55, "‘대로’ 띄어쓰기"],
    [/말하는대로/g, "말하는 대로", 0.55, "‘대로’ 띄어쓰기"],
    [/생각나는대로/g, "생각나는 대로", 0.55, "‘대로’ 띄어쓰기"],
    [/흘러가는대로/g, "흘러가는 대로", 0.55, "‘대로’ 띄어쓰기"],
    [/느끼는대로/g, "느끼는 대로", 0.55, "‘대로’ 띄어쓰기"],
    [/움직이는대로/g, "움직이는 대로", 0.55, "‘대로’ 띄어쓰기"],
    [/쓰는대로/g, "쓰는 대로", 0.55, "‘대로’ 띄어쓰기"],
    [/읽는대로/g, "읽는 대로", 0.55, "‘대로’ 띄어쓰기"],
    [/적는대로/g, "적는 대로", 0.55, "‘대로’ 띄어쓰기"],
    [/그리는대로/g, "그리는 대로", 0.55, "‘대로’ 띄어쓰기"],
    [/바라는대로/g, "바라는 대로", 0.55, "‘대로’ 띄어쓰기"],
    [/느껴지는대로/g, "느껴지는 대로", 0.55, "‘대로’ 띄어쓰기"],
    [/(^|[^가-힣])데로(?=[^가-힣]|$)/g, "$1대로", 0.72, "맞춤법+띄어쓰기: ‘대로’ 표기"],
  ];

  for (const [pattern, replace, confidence, reason] of phrasePairs) {
    add(pattern, replace, confidence, reason);
  }

  const places = [
    "집에",
    "학교에",
    "회사에",
    "방에",
    "교실에",
    "연습실에",
    "무대에",
    "길에",
    "도시에",
    "시골에",
    "카페에",
    "도서관에",
    "차에",
    "버스에",
    "기차에",
    "산에",
    "바다에",
    "호수에",
    "계곡에",
  ];
  const connectors = [
    "도착하면",
    "도착해서",
    "도착하자마자",
    "돌아와서",
    "돌아가서",
    "돌아오면",
    "돌아가면",
    "들어가서",
    "들어가며",
    "들어오면",
    "들어오자마자",
    "나가서",
    "나가며",
    "나왔는데",
    "나오면서",
    "나오자마자",
    "걸어나가며",
    "뛰어나가며",
    "걸어나오며",
  ];
  for (const place of places) {
    for (const connector of connectors) {
      const combined = `${place}${connector}`;
      const spaced = `${place} ${connector}`;
      add(combined, spaced, 0.66, "장소+동사 연결 띄어쓰기");
    }
  }

  return rules;
};

const makeSpacingSet = (): Rule[] => [...makeSpacingParticles(), ...makeSpacingNumeric(), ...makeSpacingPhrases()];

const makeFixedCommon = (): Rule[] => [
  r("됬", "됐", "‘됐’ 표기", 0.98),
  r("됫", "됐", "‘됐’ 표기", 0.98),
  r("할께", "할게", "표준어 ‘할게’", 0.97),
  r("갈께", "갈게", "표준어 ‘갈게’", 0.97),
  r("볼께", "볼게", "표준어 ‘볼게’", 0.97),
  r("줄께", "줄게", "표준어 ‘줄게’", 0.97),
  r("올께", "올게", "표준어 ‘올게’", 0.97),
  r("할려고", "하려고", "표준어 ‘하려고’", 0.9),
  r("갈려고", "가려고", "표준어 ‘가려고’", 0.9),
  r("볼려고", "보려고", "표준어 ‘보려고’", 0.9),
  r("줄려고", "주려고", "표준어 ‘주려고’", 0.9),
  r("되요", "돼요", "‘돼요’ 표기", 0.85),
  r("안되요", "안 돼요", "띄어쓰기+‘돼요’", 0.8),
  r("어쨋든", "어쨌든", "표준어", 0.85),
  r("오랫만", "오랜만", "표준어", 0.9),
  r("금새", "금세", "표준어", 0.9),
  r("헷깔", "헷갈", "표준어", 0.9),
  r("햇갈", "헷갈", "표준어", 0.9),
  r("왠일", "웬일", "표준어", 0.9),
  r("왠만", "웬만", "표준어", 0.9),
  r("어제밤", "어젯밤", "표준어 ‘어젯밤’", 0.9),
  r("앉아있", "앉아 있", "띄어쓰기(제안)", 0.7),
  r("있을까", "있을까?", "문장부호(제안)", 0.3),
  r("이어졌다", "이어 졌다", "띄어쓰기(제안)", 0.3),
  r("음악은", "음악 은", "띄어쓰기(제안)", 0.25),
  r("친구가", "친구 가", "띄어쓰기(제안)", 0.25),
  r("어떡해", "어떻게", "표준어(제안)", 0.55),
  r("안되", "안 돼", "표준어(제안)", 0.55),
];

export const KO_SPELLCHECK_RULES: Rule[] = [
  ...makeFixedCommon(),
  ...makePastTypos(),
  ...makeSpacingSet(),
  r(" {2,}", " ", "중복 공백 제거", 0.9),
  r(",{2,}", ",", "중복 쉼표 제거", 0.7),
  r("\\.{4,}", "...", "말줄임표 정리", 0.7),
  r("!{2,}", "!", "중복 느낌표 정리", 0.6),
  r("\\?{2,}", "?", "중복 물음표 정리", 0.6),
];

console.log("[spellcheck][ko] rule count", KO_SPELLCHECK_RULES.length);

// 기존 코드 호환을 위해 Rule type 재노출
export default KO_SPELLCHECK_RULES;
